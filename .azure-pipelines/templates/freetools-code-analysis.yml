# FreeTools Code Analysis Only (No Screenshots)
# Lightweight template for code metrics and route discovery
#
# Usage:
#   - template: path/to/freetools-code-analysis.yml
#     parameters:
#       targetDirectory: 'src/MyBlazorApp'
#
# Developed by Enrollment Information Technology (EIT) at Washington State University
# https://em.wsu.edu/eit/meet-our-staff/
# https://github.com/WSU-EIT/FreeTools

parameters:
  - name: targetDirectory
    type: string
    
  - name: reportName
    type: string
    default: ''
    
  - name: outputDirectory
    type: string
    default: '$(Build.ArtifactStagingDirectory)/freetools-report'

steps:
  # Determine report name
  - pwsh: |
      $reportName = '${{ parameters.reportName }}'
      if ([string]::IsNullOrEmpty($reportName)) {
        $reportName = Split-Path '${{ parameters.targetDirectory }}' -Leaf
      }
      Write-Host "##vso[task.setvariable variable=ReportName]$reportName"
    displayName: 'Determine report name'

  # Clone FreeTools
  - pwsh: |
      if (-not (Test-Path 'FreeTools')) {
        git clone --depth 1 https://github.com/WSU-EIT/FreeTools.git FreeTools
      }
    displayName: 'Get FreeTools'

  # Build tools
  - task: DotNetCoreCLI@2
    displayName: 'Build FreeTools'
    inputs:
      command: 'build'
      projects: |
        FreeTools/FreeTools/FreeTools.Core/FreeTools.Core.csproj
        FreeTools/FreeTools/FreeTools.WorkspaceInventory/FreeTools.WorkspaceInventory.csproj
        FreeTools/FreeTools/FreeTools.EndpointMapper/FreeTools.EndpointMapper.csproj
      arguments: '--configuration Release'

  # WorkspaceInventory
  - task: DotNetCoreCLI@2
    displayName: 'Analyze Workspace'
    inputs:
      command: 'run'
      projects: 'FreeTools/FreeTools/FreeTools.WorkspaceInventory/FreeTools.WorkspaceInventory.csproj'
      arguments: '--configuration Release -- "${{ parameters.targetDirectory }}" "${{ parameters.outputDirectory }}/workspace-inventory.csv"'

  # EndpointMapper
  - task: DotNetCoreCLI@2
    displayName: 'Discover Routes'
    inputs:
      command: 'run'
      projects: 'FreeTools/FreeTools/FreeTools.EndpointMapper/FreeTools.EndpointMapper.csproj'
      arguments: '--configuration Release -- "${{ parameters.targetDirectory }}" "${{ parameters.outputDirectory }}/pages.csv"'

  # Generate summary
  - pwsh: |
      $outputDir = '${{ parameters.outputDirectory }}'
      $reportName = '$(ReportName)'
      
      # Read CSVs and generate simple summary
      $workspace = Import-Csv "$outputDir/workspace-inventory.csv"
      $pages = Import-Csv "$outputDir/pages.csv"
      
      $summary = @"
# $reportName - Code Analysis Summary

Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Branch: $(Build.SourceBranchName)
Commit: $(Build.SourceVersion)

## Workspace Metrics

| Metric | Value |
|--------|-------|
| Total Files | $($workspace.Count) |
| Total Lines | $($workspace | Measure-Object -Property LineCount -Sum | Select-Object -ExpandProperty Sum) |
| Razor Pages | $($workspace | Where-Object { $_.Kind -eq 'RazorPage' } | Measure-Object | Select-Object -ExpandProperty Count) |
| Components | $($workspace | Where-Object { $_.Kind -eq 'RazorComponent' } | Measure-Object | Select-Object -ExpandProperty Count) |
| C# Files | $($workspace | Where-Object { $_.Kind -eq 'CSharpSource' } | Measure-Object | Select-Object -ExpandProperty Count) |

## Routes Discovered

| Metric | Value |
|--------|-------|
| Total Routes | $($pages.Count) |
| Public Routes | $($pages | Where-Object { $_.RequiresAuth -eq 'false' } | Measure-Object | Select-Object -ExpandProperty Count) |
| Protected Routes | $($pages | Where-Object { $_.RequiresAuth -eq 'true' } | Measure-Object | Select-Object -ExpandProperty Count) |

---
*Generated by [FreeTools](https://github.com/WSU-EIT/FreeTools) - Enrollment Information Technology, Washington State University*
"@
      
      $summary | Out-File "$outputDir/$reportName-Summary.md" -Encoding UTF8
      Write-Host $summary
    displayName: 'Generate Summary'

  # Publish artifacts
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Analysis'
    inputs:
      targetPath: '${{ parameters.outputDirectory }}'
      artifact: 'FreeTools-$(ReportName)-CodeAnalysis'
      publishLocation: 'pipeline'
