# FreeTools.BrowserSnapshot — Screenshot Capture Tool

> **Purpose:** Captures full-page screenshots of all routes discovered by EndpointMapper using Playwright, with smart timing for SPAs and automatic retry for reliability.  
> **Last Reviewed:** 2025-12-30  
> **Version:** 2.1

---

## Overview

The **BrowserSnapshot** tool is a development utility that:

- **Reads routes:** Loads routes from CSV generated by EndpointMapper
- **Captures screenshots:** Uses Playwright to render pages and capture full-page screenshots
- **Smart SPA timing:** Uses `NetworkIdle` wait strategy for better Blazor/SPA support
- **Auto-retry:** Automatically retries screenshots that appear blank (< 10KB)
- **Console error capture:** Records JavaScript errors during page load
- **Metadata output:** Writes `metadata.json` alongside each screenshot for reporting
- **Multiple browsers:** Supports Chromium, Firefox, and WebKit
- **Parallel execution:** Supports configurable thread count for fast capture
- **Auto-installs browsers:** Automatically downloads Playwright browsers on first run

---

## What's New in v2.1

| Feature | Description |
|---------|-------------|
| **NetworkIdle wait** | Waits for network to go quiet instead of just HTML load — fixes blank screenshots on SPAs |
| **Configurable settle delay** | `PAGE_SETTLE_DELAY_MS` env var (default 3000ms) for post-load wait time |
| **Auto-retry** | Screenshots < 10KB are automatically retried with extra delay |
| **Console error capture** | JavaScript errors logged during page load |
| **Metadata files** | Each screenshot now has a `metadata.json` with capture stats |
| **Screenshot health** | Report now shows success rate and flags suspicious captures |

---

## Technology Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| .NET | 10.0 | Runtime framework |
| Microsoft.Playwright | 1.49.0 | Browser automation |

---

## Usage

### Via Aspire AppHost (Recommended)

The tool runs automatically when starting FreeTools.AppHost (waits for web app):

```bash
cd FreeTools/FreeTools.AppHost
dotnet run
```

### Standalone

```bash
cd FreeTools/FreeTools.BrowserSnapshot

# Run the tool (browsers auto-install on first run)
dotnet run [baseUrl] [csvPath] [outputDir] [maxThreads]
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `BASE_URL` | Base URL of the web app | `https://localhost:5001` |
| `CSV_PATH` | Path to pages.csv | `pages.csv` |
| `OUTPUT_DIR` | Directory for screenshot output | `page-snapshots` |
| `SCREENSHOT_BROWSER` | Browser to use (chromium/firefox/webkit) | `chromium` |
| `SCREENSHOT_VIEWPORT` | Viewport size (WIDTHxHEIGHT) | Playwright default |
| `MAX_THREADS` | Maximum parallel captures | `10` |
| `PAGE_SETTLE_DELAY_MS` | Wait time after NetworkIdle before screenshot | `3000` |
| `START_DELAY_MS` | Startup delay for server warmup | `5000` |

---

## Output Structure

Screenshots are saved alongside HTML files from EndpointPoker:

```
snapshots/
├── root/
│   ├── default.png           # Screenshot
│   └── metadata.json         # Capture metadata (NEW in v2.1)
├── Account/
│   └── Login/
│       ├── default.png
│       └── metadata.json
└── weather/
    ├── default.png
    └── metadata.json
```

### Metadata File Format

Each screenshot has an accompanying `metadata.json`:

```json
{
  "route": "/Account/Login",
  "url": "https://localhost:5001/Account/Login",
  "statusCode": 200,
  "fileSize": 45231,
  "isSuspiciouslySmall": false,
  "retryAttempted": false,
  "consoleErrors": [],
  "capturedAt": "2025-12-30T10:15:00Z",
  "isSuccess": true,
  "isHttpError": false,
  "isError": false,
  "errorMessage": null
}
```

---

## Console Output

```
============================================================
 BrowserSnapshot (FreeTools) v2.1
============================================================
  BASE_URL:      https://localhost:5001
  CSV_PATH:      pages.csv
  OUTPUT_DIR:    snapshots
  BROWSER:       chromium
  SETTLE_DELAY:  3000ms
------------------------------------------------------------

[1/36] /
  URL: https://localhost:5001/
  -> Status: 200
  -> Saved: default.png (45.2 KB)

[2/36] /Account/Login
  URL: https://localhost:5001/Account/Login
  -> Status: 200
  -> Saved: default.png (2.1 KB) ⚠️ SUSPICIOUS (retried)
  -> JS Errors: 1

------------------------------------------------------------
Summary
------------------------------------------------------------
  ✅ Successful (2xx/3xx): 34
  ❌ HTTP errors (4xx/5xx): 2
  ⚠️ Browser/timeout errors: 0
  🔄 Retried (small file): 1
  ⚠️ Suspicious (<10KB): 0
```

---

## Integration

```
┌─────────────────────────────────────────────────────────────────┐
│                      FreeTools Pipeline                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. EndpointMapper     2. EndpointPoker    3. BrowserSnapshot   │
│  ┌────────────┐        ┌────────────┐      ┌────────────────┐   │
│  │ Scan .razor│───────►│ HTTP GET   │      │ Playwright     │   │
│  │ files      │        │ each route │      │ screenshots    │   │
│  └────────────┘        └────────────┘      └────────────────┘   │
│        │                     │                    │             │
│        ▼                     ▼                    ▼             │
│   pages.csv            *.html files          *.png + metadata   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Timing Strategy

The tool uses a two-phase wait strategy optimized for Blazor/SPA applications:

1. **NetworkIdle** — Waits until network has been idle for 500ms (all resources loaded)
2. **Settle Delay** — Additional configurable wait (default 3000ms) for JavaScript rendering

```
Navigate ──► NetworkIdle (network quiet) ──► Settle Delay ──► Screenshot
                    │                              │
                    │                              └── Configurable via
                    │                                  PAGE_SETTLE_DELAY_MS
                    │
                    └── Waits for Blazor WASM, API calls, etc.
```

If the screenshot is suspiciously small (< 10KB), the tool waits an additional 3 seconds and retries once.

---

## Browser Installation

Playwright browsers are **automatically installed** on first run. 

For manual installation:

```bash
# PowerShell (Windows)
pwsh bin/Debug/net10.0/playwright.ps1 install chromium

# Or install all browsers
pwsh bin/Debug/net10.0/playwright.ps1 install
```

---

## 📬 About

**FreeTools** is developed and maintained by **[Enrollment Information Technology (EIT)](https://em.wsu.edu/eit/meet-our-staff/)** at **Washington State University**.

📧 Questions or feedback? Visit our [team page](https://em.wsu.edu/eit/meet-our-staff/) or open an issue on [GitHub](https://github.com/WSU-EIT/FreeTools/issues).

---

*Part of the FreeTools suite*
